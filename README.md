
# レセプトマスタCSVデータをSQLiteデータベースにインポートするスクリプト

## 概要

このスクリプトは、レセプトマスタCSVファイルからSQLiteデータベースにデータをインポートします。ファイル名によってデータの処理と保存先のテーブルが決まります。

## 必要なもの

- Python 3.x
- `pandas` ライブラリ
- `sqlite3` ライブラリ（Python標準ライブラリに含まれています）

## マスタ取得先
https://shinryohoshu.mhlw.go.jp/shinryohoshu/downloadMenu/

## ディレクトリ構成

以下のようにディレクトリを構成してください：

```
your_project_directory/
│
├── datas/
│   ├── [csv_files...]
│   ├── RECEDB
│
└── insert_master.py
```

- `datas/`：インポートするCSVファイルを格納するディレクトリ。
- `insert_master.py`：データインポートを実行するスクリプト。

## CSVファイルの命名規則

スクリプトは、CSVファイルの名前の先頭にある1文字で、データの処理方法と保存先のテーブルを決定します。ファイルのプレフィックスは次のキーのいずれかと一致する必要があります：

- `s`：診療行為マスタファイル
- `b`：病名マスタファイル
- `t`：特定機材マスタファイル
- `y`：医薬品マスタファイル

## CSVファイルの形式

各CSVファイルは次の形式に従ってください：

1. CSVファイルにヘッダーは含まれていません。
2. 関連する列は以下のインデックスで指定されています（[コード,名称]）：
    - `s`：診療行為マスタ、列インデックス [2, 4] を使用します。
    - `b`：病名マスタ、列インデックス [2, 5] を使用します。
    - `t`：特定機材マスタ、列インデックス [2, 4] を使用します。
    - `y`：医薬品マスタ、列インデックス [2, 4] を使用します。

## スクリプトの機能

### `insert_master(df: pd.DataFrame, table_name: str) -> str`

DataFrame `df` を指定したSQLiteテーブル `table_name` に挿入します。テーブルが存在する場合は、テーブルが置き換えられます。成功メッセージまたはエラーメッセージを返します。

### `read_master(in_dir: Path) -> None`

指定されたディレクトリ `in_dir` からCSVファイルを読み取り、命名規則に従って処理し、適切なSQLiteテーブルにデータを挿入します。

### `main()`

入力ディレクトリを設定し、データの読み取りとインポート処理を開始します。

## 実行方法

1. CSVファイルを `datas` ディレクトリに配置します。
2. SQLiteのデータベースファイル `RECEDB` を `datas` ディレクトリに配置します。
3. `your_script.py` をプロジェクトディレクトリに置きます。
4. コマンドラインからスクリプトを実行します：

    ```sh
    python insert_master.py
    ```

## 注意事項

- CSVファイルは `cp932` エンコーディングで保存されている必要があります。
- データベースファイル `RECEDB` は、まだ存在しない場合には `datas` ディレクトリ内に作成されます。
- スクリプトは、データインポート時に各DataFrameに現在のタイムスタンプを持つ `updated_at` 列を追加します。
